## Amend CARRA GRIB headers with grib_filter for daily mean, instantaneous forecasts.

## WARNING: Assume daily mean calculated using:
##          3 hourly, 3 hour forecasts from 21 UTC (day-1) to 18 UTC (day), all T+3.
## WARNING: Before running grib_filter, replace upper case strings below with actual values.

## Usage: grib_filter -o output_file.grib rules_script input_file.grib

  assert ( dataDate == DDATE );
  assert ( dataTime == DTIME );
#  assert ( editionNumber == 2 );
  assert ( productDefinitionTemplateNumber == 0 );
#  assert ( productDefinitionTemplateNumber == 0 || productDefinitionTemplateNumber == 1 );
## Start time of forecast
  assert ( significanceOfReferenceTime == 1 );
## Forecast time (step)
  assert ( forecastTime == 3 );

## Template for statistical pprocessing
  set productDefinitionTemplateNumber=8;

## 21 UTC on day
  set yearOfEndOfOverallTimeInterval=ENDYEAR;
  set monthOfEndOfOverallTimeInterval=ENDMONTH;
  set dayOfEndOfOverallTimeInterval=ENDDAY;
  set hourOfEndOfOverallTimeInterval=ENDHOUR;
  set minuteOfEndOfOverallTimeInterval=0;
  set secondOfEndOfOverallTimeInterval=0;

  set numberOfMissingInStatisticalProcess=0;

## The first time-range block: start time of forecast
  set numberOfTimeRange=1;
## Averaging
  set typeOfStatisticalProcessing=0;
## Start time of forecast is incremented
  set typeOfTimeIncrement=1;
## 21 hours range (21 to 18), range=end-start; (OR 24 hours)
  set indicatorOfUnitForTimeRange=1;
  set lengthOfTimeRange=21;
## 3 hourly increments
  set indicatorOfUnitForTimeIncrement=1;
  set timeIncrement=3;

write;

